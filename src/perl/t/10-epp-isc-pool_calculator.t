use strict;
use warnings;
use Test::More tests => 6;
use XML::LibXML;

local $ENV{'WTSI_CLARITY_HOME'}= q[t/data/config];
local $ENV{'SAVE2WTSICLARITY_WEBCACHE'} = 0;
local $ENV{'WTSICLARITY_WEBCACHE_DIR'} = 't/data/epp/isc/pool_calculator';

use_ok('wtsi_clarity::epp::isc::pool_calculator');

{
  my $pool_calculator = wtsi_clarity::epp::isc::pool_calculator->new(
    process_url => 'http://testserver.com:1234/processes/24-22178',
  );

  is($pool_calculator->min_volume, 5, 'Fetches the min volume correctly');
  is($pool_calculator->max_volume, 50, 'Fetches the max volume correctly');
  is($pool_calculator->max_total_volume, 200, 'Fetches the max total volume correctly');
}

{
  my $pool_calculator = wtsi_clarity::epp::isc::pool_calculator->new(
    process_url => 'http://testserver.com:1234/processes/122-22367',
  );

  my $input_output_map = [
     ["2-75704", "2-83064"],
     ["2-75717", "2-83053"],
     ["2-75718", "2-83053"],
     ["2-75710", "2-83054"],
     ["2-75709", "2-83054"],
     ["2-75712", "2-83055"],
     ["2-75711", "2-83055"],
     ["2-75714", "2-83056"],
     ["2-75713", "2-83056"],
     ["2-75716", "2-83057"],
     ["2-75715", "2-83057"],
     ["2-75705", "2-83058"],
     ["2-75706", "2-83059"],
     ["2-75707", "2-83060"],
     ["2-75708", "2-83061"],
     ["2-75702", "2-83062"],
     ["2-75703", "2-83063"],
  ];

  is_deeply ($pool_calculator->_input_output_map, $input_output_map, "Generates the input-output list of tuples correctly");
}

{
  my $pool_calculator = wtsi_clarity::epp::isc::pool_calculator->new(
    process_url => 'http://testserver.com:1234/here/processes/122-22453',
  );

  my $molarities = {
            'D:5' => '3.78445151662068',
            'E:4' => '1.70896456966391',
            'E:11' => '0.0362071365718036',
            'B:10' => '0.00434280458285593',
            'H:10' => '0.0290827100511876',
            'A:8' => '2.79442804215418',
            'E:9' => '0.0179072665054354',
            'C:7' => '8.00651742225999',
            'C:2' => '3.85775724317892',
            'E:8' => '6.68994835398722',
            'H:5' => '6.49377477267991',
            'H:4' => '7.34384083630527',
            'B:2' => '3.68660683203058',
            'A:12' => '0.00772994312435155',
            'F:6' => '7.93338413416683',
            'C:4' => '3.31854203587479',
            'F:7' => '9.22339278138472',
            'B:8' => '2.86181275223545',
            'E:7' => '7.69449654647083',
            'G:6' => '6.51618328039304',
            'F:1' => '8.60815184677848',
            'E:12' => '0.00317616052033608',
            'C:11' => '0.0196000188331788',
            'G:5' => '4.13096968374669',
            'B:12' => '0.0100375605683005',
            'F:11' => '0.0086304885746298',
            'B:6' => '6.62303835806759',
            'D:9' => '0.019620661005732',
            'C:9' => '0.0137982680677704',
            'A:2' => '2.6586982533121',
            'D:12' => '0.0215651827205918',
            'F:9' => '0.00527367436826845',
            'H:3' => '1.50046020319584',
            'B:4' => '2.55492915115587',
            'F:8' => '0.0180592664945838',
            'H:9' => '5.01522296628195',
            'D:10' => '0.0269827277962546',
            'A:3' => '6.34737408613118',
            'D:7' => '8.37311035678717',
            'C:10' => '0.00792068064335775',
            'C:6' => '10.2164731285907',
            'G:11' => '0.0242632862865845',
            'B:1' => '2.54349312325487',
            'F:2' => '9.33317986901055',
            'A:4' => '2.14780084881615',
            'B:9' => '0.0145527479002988',
            'G:9' => '0.0339087681867051',
            'C:8' => '8.44301206745552',
            'A:7' => '10.4444679614185',
            'H:8' => '0',
            'B:3' => '8.63970680967977',
            'F:3' => '3.15328068033206',
            'E:5' => '5.32846735227037',
            'G:10' => '0.0338182856742102',
            'C:1' => '1.84074401124385',
            'E:6' => '3.04387280070513',
            'A:9' => '0.0130787496154015',
            'F:5' => '10.6966641802758',
            'H:11' => '0.0179572511632611',
            'B:5' => '7.14289834909745',
            'H:1' => '4.54825004105438',
            'G:4' => '5.89069413183969',
            'D:8' => '6.18777418363968',
            'G:7' => '3.74219059650824',
            'D:2' => '3.25918732574683',
            'F:4' => '4.50947030241593',
            'C:12' => '0.0127668710806857',
            'A:11' => '0',
            'E:10' => '0.0137533518598289',
            'B:11' => '0.0175512375552711',
            'G:8' => '0.0154531209408479',
            'H:2' => '7.16904942990097',
            'H:7' => '4.35532154355001',
            'A:5' => '7.08443655581096',
            'G:12' => '0.0214933572726912',
            'E:2' => '4.1866277693417',
            'G:3' => '5.96652943684305',
            'E:3' => '7.25900237670598',
            'G:1' => '6.26822037856869',
            'B:7' => '5.16415833057616',
            'H:12' => '0.003823005614082',
            'H:6' => '4.97911848467598',
            'G:2' => '14.5128685036518',
            'A:10' => '0.0188324964105518',
            'A:1' => '2.21580732120758',
            'A:6' => '4.38968747349963',
            'D:11' => '0.0058999700419346',
            'E:1' => '1.77098493340939',
            'F:12' => '0.0181413650158161',
            'D:1' => '7.46339269313873',
            'C:3' => '5.47689141847769',
            'D:6' => '3.88996413149026',
            'C:5' => '6.67922425777302',
            'D:4' => '2.32416536908994',
            'F:10' => '0',
            'D:3' => '2.15933982316326'
          };

  is_deeply($pool_calculator->_96_plate_molarities, $molarities, 'Fetches the molarities correctly');
}

1;